{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="card-title mb-0">Deployment Control</h4>
                    <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">Environment: DEV</span>
                </div>

                <div id="status-section" class="alert alert-light border text-center py-5">
                    <p class="mb-3 text-muted">Check for new changes before triggering a deployment.</p>
                    <button id="check-btn" class="btn btn-primary">
                        <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status"
                            aria-hidden="true"></span>
                        Check for Updates
                    </button>
                    <div id="status-result" class="mt-4 d-none text-start">
                        <!-- Result injected here -->
                    </div>
                </div>

                <div id="deployment-confirm" class="d-none mt-4">
                    <div class="alert alert-warning border-warning">
                        <h5>Ready to Deploy?</h5>
                        <p>You are about to trigger a deployment for the changes listed above.</p>
                        <form action="{{ url_for('trigger_deployment') }}" method="POST">
                            <button type="submit" class="btn btn-warning text-dark fw-bold">ðŸš€ Trigger Deployment
                                Now</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header bg-white pt-4 border-bottom-0">
                <h5 class="mb-0">Recent Successful Builds (Azure DevOps)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Build Number</th>
                                <th>Status</th>
                                <th>Result</th>
                                <th>Finished</th>
                                <th>Triggered By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for build in azure_builds %}
                            <tr>
                                <td>
                                    <span class="fw-medium">{{ build.build_number }}</span>
                                    <br>
                                    <small class="text-muted">Source: {{ build.source_version[:8] }}</small>
                                </td>
                                <td>{{ build.status }}</td>
                                <td>
                                    {% if build.result == 'succeeded' %}
                                    <span class="badge bg-success">Succeeded</span>
                                    {% elif build.result == 'partiallySucceeded' %}
                                    <span class="badge bg-warning text-dark">Partial</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ build.result }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ build.finish_time[:16].replace('T', ' ') if build.finish_time else 'N/A' }}</td>
                                <td><small>{{ build.requested_for }}</small></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">No recent builds found or API error.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-white pt-4 border-bottom-0">
                <h5 class="mb-0">Create Pull Request</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('create_pr_route') }}" method="POST">
                    <div class="mb-3">
                        <label for="source_branch" class="form-label">Source Branch</label>
                        <input type="text" class="form-control" id="source_branch" name="source_branch"
                            placeholder="feature/ADW-..." required>
                    </div>
                    <div class="mb-3">
                        <label for="target_branch" class="form-label">Target Branch</label>
                        <select class="form-select" id="target_branch" name="target_branch">
                            <option value="dev" selected>dev</option>
                            <option value="master">master</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">PR Title</label>
                        <input type="text" class="form-control" id="title" name="title"
                            placeholder="ADW-XXXX [Merkle] Description" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-dark w-100">Create Pull Request</button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-white border-bottom-0 pt-4">
                <h5 class="mb-0">Recent Activity</h5>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for log in logs %}
                    <li class="list-group-item px-4 py-3">
                        <div class="d-flex w-100 justify-content-between">
                            <small class="text-muted">{{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                            <span class="badge bg-secondary rounded-pill">{{ log.status }}</span>
                        </div>
                        <p class="mb-1 fw-medium">Build #{{ log.build_number or 'Pending' }}</p>
                        <small class="text-muted">By {{ log.triggered_by }}</small>
                    </li>
                    {% else %}
                    <li class="list-group-item px-4 py-3 text-muted text-center">No recent history</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.getElementById('check-btn').addEventListener('click', function () {
        const btn = this;
        const spinner = document.getElementById('spinner');
        const resultDiv = document.getElementById('status-result');
        const confirmDiv = document.getElementById('deployment-confirm');

        // Reset UI
        btn.disabled = true;
        spinner.classList.remove('d-none');
        resultDiv.classList.add('d-none');
        confirmDiv.classList.add('d-none');

        fetch('/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                spinner.classList.add('d-none');

                resultDiv.classList.remove('d-none');

                if (data.status === 'success') {
                    let html = `<h6>Based on Build: <span class="badge bg-light text-dark border">${data.build_info.build_number}</span></h6>`;
                    html += `<hr class="my-3">`;

                    if (data.count > 0) {
                        html += `<div class="text-success fw-bold mb-2">âœ… Found ${data.count} new PR(s) to deploy:</div>`;
                        html += `<ul class="list-group mb-3">`;
                        data.pr_merges.forEach(pr => {
                            html += `<li class="list-group-item">
                        <span class="fw-bold">${pr.jira_ticket || 'No Ticket'}</span> - ${pr.description} 
                        <span class="text-muted small">(${pr.author})</span>
                    </li>`;
                        });
                        html += `</ul>`;

                        // Show deploy button
                        confirmDiv.classList.remove('d-none');
                    } else {
                        html += `<div class="text-muted">No new PRs found. Environment is up to date.</div>`;
                    }
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="text-danger">Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                btn.disabled = false;
                spinner.classList.add('d-none');
                resultDiv.classList.remove('d-none');
                resultDiv.innerHTML = `<div class="text-danger">Network Error: ${error}</div>`;
            });
    });
</script>
{% endblock %}